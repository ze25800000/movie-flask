# 3-2 蓝图构建项目目录
![蓝图构建项目目录](https://raw.githubusercontent.com/ze25800000/movie-flask/master/pic/lantu.jpg)
# 3-3 会员及会员登录日志数据模型设计

![会员及会员登录日志数据模型设计](https://github.com/ze25800000/movie-flask/blob/master/pic/%E4%BC%9A%E5%91%98%E5%8F%8A%E4%BC%9A%E5%91%98%E7%99%BB%E5%BD%95%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.jpg?raw=true)
![定义会员数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/%E5%AE%9A%E4%B9%89%E4%BC%9A%E5%91%98%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)
![定义会员登录日志数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/%E5%AE%9A%E4%B9%89%E4%BC%9A%E5%91%98%E7%99%BB%E5%BD%95%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)
![定义会员数据模型及关联](https://github.com/ze25800000/movie-flask/blob/master/pic/%E5%AE%9A%E4%B9%89%E4%BC%9A%E5%91%98%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E5%8F%8A%E5%85%B3%E8%81%94.jpg?raw=true)

# 3-4 标签-电影-上映预告数据模型设计
![标签、电影、上映预告数据模型设计](https://github.com/ze25800000/movie-flask/blob/master/pic/%E6%A0%87%E7%AD%BE%E3%80%81%E7%94%B5%E5%BD%B1%E3%80%81%E4%B8%8A%E6%98%A0%E9%A2%84%E5%91%8A%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.jpg?raw=true)
![定义电影数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/3-4-2%E5%AE%9A%E4%B9%89%E7%94%B5%E5%BD%B1%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)
![定义上映预告数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/3-4-3%E5%AE%9A%E4%B9%89%E4%B8%8A%E6%98%A0%E9%A2%84%E5%91%8A%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)

# 3-5 评论及收藏电影数据模型设计
![3-5-1评论及收藏电影数据模型设计](https://github.com/ze25800000/movie-flask/blob/master/pic/3-5-1%E8%AF%84%E8%AE%BA%E5%8F%8A%E6%94%B6%E8%97%8F%E7%94%B5%E5%BD%B1%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.jpg?raw=true)
![3-5-2定义收藏电影数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/3-5-2%E5%AE%9A%E4%B9%89%E6%94%B6%E8%97%8F%E7%94%B5%E5%BD%B1%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)

# 3-6 权限及角色数据模型设计
![3-6-1权限及角色数据模型设计](https://github.com/ze25800000/movie-flask/blob/master/pic/3-6-1%E6%9D%83%E9%99%90%E5%8F%8A%E8%A7%92%E8%89%B2%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.jpg?raw=true)
![3-6-2定义角色数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/3-6-2%E5%AE%9A%E4%B9%89%E8%A7%92%E8%89%B2%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)

# 3-7 管理员、登录日志、操作日志数据模型设计
![3-7-1管理员、登录日志、操作日志数据模型设计](https://github.com/ze25800000/movie-flask/blob/master/pic/3-7-1%E7%AE%A1%E7%90%86%E5%91%98%E3%80%81%E7%99%BB%E5%BD%95%E6%97%A5%E5%BF%97%E3%80%81%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1.jpg?raw=true)
![3-7-2定义管理员登录日志数据模型](https://github.com/ze25800000/movie-flask/blob/master/pic/3-7-2%E5%AE%9A%E4%B9%89%E7%AE%A1%E7%90%86%E5%91%98%E7%99%BB%E5%BD%95%E6%97%A5%E5%BF%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg?raw=true)
![3-7-3定义操作日志](https://github.com/ze25800000/movie-flask/blob/master/pic/3-7-3%E5%AE%9A%E4%B9%89%E6%93%8D%E4%BD%9C%E6%97%A5%E5%BF%97.jpg?raw=true)

### 执行models.py生成数据表
1. 安装pymysql pip install pymysql
2. import pymysql
```
app.config["SQLALCHEMY_DATABASE_URI"] = "mysql+pymysql://root:Yangze@1234@127.0.0.1:3306/movie"
```
3.  创建表时，修改字符集
```
__table_args__ = {'mysql_collate': 'utf8_general_ci'}
# 最下面加如下代码
if __name__ == "__main__":
     db.create_all()
```
4.  python models.py

5. 插入role角色表字段
```
if __name__ == "__main__":
    role = Role(
        name="超级管理员",
        auths=""
    )
    db.session.add(role)
    db.session.commit()
```

6. 插入admin管理员字段
```
if __name__ == "__main__":
    from werkzeug.security import generate_password_hash

    admin = Admin(
        name="admin",
        pwd=generate_password_hash("yangze"),
        is_super=0,
        role_id=1
    )
    db.session.add(admin)
    db.session.commit()
```

# 4-1 前台布局搭建
![4-1-1前台布局搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-1-1%E5%89%8D%E5%8F%B0%E5%B8%83%E5%B1%80%E6%90%AD%E5%BB%BA.jpg?raw=true)

# 4-2 会员登录页面搭建
![4-2-1会员登录页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-2-1%E4%BC%9A%E5%91%98%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E6%90%AD%E5%BB%BA.jpg?raw=true)

# 4-3 会员注册页面搭建
![4-3-1会员注册页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-3-1%E4%BC%9A%E5%91%98%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%E6%90%AD%E5%BB%BA.jpg?raw=true)

# 4-4 会员中心页面搭建
![4-4-1会员中心页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-4-1%E4%BC%9A%E5%91%98%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2%E6%90%AD%E5%BB%BA.jpg?raw=true)

# 4-5 电影列表页面搭建
![4-5-1电影列表页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-5-1.jpg?raw=true)

# 4-6 电影搜索页面搭建
![4-6-1电影搜索页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-6-1.jpg?raw=true)

# 4-7 电影详情页面搭建
![4-7-1电影搜索页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-7-1.jpg?raw=true)

# 4-8 404页面搭建
在app目录__init__.py下添加
![4-8-1404页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/4-8-1.jpg?raw=true)

# 5-1 后台页面搭建
![5-1-1后台页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-1-1.jpg?raw=true)

# 5-2 后台布局搭建
![5-2-1后台页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-2-1.jpg?raw=true)

# 5-3 修改密码界面搭建
![5-3-1修改密码界面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-3-1.jpg?raw=true)

# 5-4 控制面板页面搭建
![5-4-1控制面板页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-4-1.jpg?raw=true)

# 5-5 标签管理页面搭建
![5-5-1标签管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-5-1.jpg?raw=true)

# 5-6 电影管理页面搭建
![5-6-1标签管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-6-1.jpg?raw=true)

# 5-7 上映预告管理页面搭建
![5-7-1上映预告管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-7-1.jpg?raw=true)

# 5-8 会员管理页面搭建
![5-8-1会员管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-8-1.jpg?raw=true)

# 5-9 评论管理页面搭建
![5-9-1评论管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-9-1.jpg?raw=true)

# 5-10 收藏管理页面搭建
![5-10-1收藏管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-10-1.jpg?raw=true)

# 5-11 操作日志管理页面搭建
![5-11-1操作日志管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-11-1.jpg?raw=true)

# 5-12 角色管理页面搭建
![5-12-1角色管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-12-1.jpg?raw=true)

# 5-13 权限管理页面搭建
![5-13-1权限管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-13-1.jpg?raw=true)

# 5-14 管理员管理页面搭建
![5-14-1管理员管理页面搭建](https://github.com/ze25800000/movie-flask/blob/master/pic/5-14-1.jpg?raw=true)

# 6-1 管理员登录
![6-1-1管理员登录](https://github.com/ze25800000/movie-flask/blob/master/pic/6-1-1.jpg?raw=true)
![6-1-2管理员登录](https://github.com/ze25800000/movie-flask/blob/master/pic/6-1-2.jpg?raw=true)
- 安装flask_wtf pip install flask_wtf
```
app.config["SECRET_KEY"] = "2240db928b0b42dea0472e4e1517af5a"

```
html中添加{{ form.csrf_token }}
```
<form method="POST" id="form-data">
    {{ form.csrf_token }}
    <div class="form-group has-feedback">
        {{ form.account }}
        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
        {% for err in form.account.errors %}
        <div class="col-md-12">
            <span style="color:red">{{ err }}</span>
        </div>
        {% endfor %}
    </div>
    <div class="form-group has-feedback">
        {{ form.pwd }}
        <span class="glyphicon glyphicon-lock form-control-feedback"></span>
        {% for err in form.pwd.errors %}
        <div class="col-md-12">
            <span style="color:red">{{ err }}</span>
        </div>
        {% endfor %}
    </div>
    <div class="row">
        <div class="col-xs-8">
        </div>
        <div class="col-xs-4">
            {{ form.submit }}
        </div>
    </div>
</form>
```
- 使用装饰器进行访问控制
```
def admin_login_req(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if "admin" not in session:
            return redirect(url_for("admin.login", next=request.url))
        return f(*args, **kwargs)

    return decorated_function
```

# 6-2 标签管理
![6-2-1标签管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-2-1.jpg?raw=true)
- 数据入库操作
```
view.py
@admin.route("/tag/add/", methods=["GET", "POST"])
@admin_login_req
def tag_add():
    form = TagForm()
    if form.validate_on_submit():
        data = form.data
        tag = Tag.query.filter_by(name=data['name']).count()
        if tag == 1:
            flash("名称已经存在", "err")
            return redirect(url_for('admin.tag_add'))
        tag = Tag(
            name=data['name']
        )
        db.session.add(tag)
        db.session.commit()
        flash('添加成功', 'ok')
        return redirect(url_for('admin.tag_add'))
    return render_template('admin/tag_add.html', form=form)
```
- html处理
```
<form role="form" method="post">
    {% for msg in get_flashed_messages(category_filter=['ok']) %}
    <div class="alert alert-success alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
        <h4><i class="icon fa fa-check">操作成功 !</i></h4>
        {{ msg }}
    </div>
    {% endfor %}
    {% for msg in get_flashed_messages(category_filter=['err']) %}
    <div class="alert alert-danger alert-dismissible">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
        <h4><i class="icon fa fa-check">操作失败 !</i></h4>
        {{ msg }}
    </div>
    {% endfor %}
    <div class="box-body">
        <div class="form-group">
            <label for="input_name">标签名称</label>
            {{ form.name }}
            {% for err in form.name.errors %}
            <div class="col-md-12">
                <span style="color: red;">{{ err }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="box-footer">
        {{ form.submit }}
        {{ form.csrf_token }}
    </div>
</form>
```
# 6-3 标签列表展示-分页
```
{% macro page(data,url) -%}
    {% if data %}
    <ul class="pagination pagination-sm no-margin pull-right">
        <li><a href="{{ url_for(url,page=1) }}">首页</a></li>

        {% if data.has_prev %}
            <li><a href="{{ url_for(url,page=data.prev_num) }}">上一页</a></li>
        {% else %}
            <li><a href="javascript:;" class="disabled">上一页</a></li>
        {% endif %}

        {% for v in data.iter_pages() %}
            {% if v==data.page %}
                <li class="active"><a href="javascript:;">{{ v }}</a></li>
            {% else %}
                <li><a href="{{ url_for(url,page=v) }}">{{ v }}</a></li>
            {% endif %}
        {% endfor %}

        {% if data.has_next %}
            <li><a href="{{ url_for(url,page=data.next_num) }}">下一页</a></li>
        {% else %}
            <li><a href="javascript:;" class="disabled">下一页</a></li>
        {% endif %}

        <li><a href="{{ url_for(url,page=data.pages) }}">尾页</a></li>
    </ul>
    {% endif %}
{%- endmacro %}
```
- 模板中调用
头部引入
```
{% import 'ui/admin_page.html' as pg %}
```
分页处引入
```
<div class="box-footer clearfix">
    {{ pg.page(page_data,'admin.tag_list') }}
</div>
```
# 6-4 标签删除、编辑操作
- 标签删除
```
@admin.route("/tag/del/<int:id>/", methods=['GET'])
@admin_login_req
def tag_del(id=None):
    tag = Tag.query.filter_by(id=id).first_or_404()
    db.session.delete(tag)
    db.session.commit()
    flash('删除标签成功！', 'ok')
    return redirect(url_for('admin.tag_list', page=1))

```
- 标签编辑
```
@admin.route("/tag/edit/<int:id>/", methods=['GET', 'POST'])
@admin_login_req
def tag_edit(id=None):
    form = TagForm()
    tag = Tag.query.get_or_404(id)
    if form.validate_on_submit():
        data = form.data
        tag_count = Tag.query.filter_by(name=data['name']).count()
        if tag.name != data['name'] and tag_count == 1:
            flash("名称已经存在", "err")
            return redirect(url_for('admin.tag_add', id=id))
        tag.name = data['name']
        db.session.add(tag)
        db.session.commit()
        flash('修改标签成功', 'ok')
        return redirect(url_for('admin.tag_edit', id=id))
    return render_template('admin/tag_edit.html', form=form, tag=tag)
```

# 6-5 电影管理-添加电影页面表单生成
![6-5-1电影管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-5-1.jpg?raw=true)


# 6-6,7 电影管理-添加电影-上传文件
1. app下的__init__.py中添加上传路径
```
app.config["UP_DIR"] = os.path.join(os.path.abspath(os.path.dirname(__file__)), "static/uploads/")
```
2. 处理上传文件
```
from werkzeug.utils import secure_filename
import os
import uuid
import datetime
```
添加修改文件名方法
```
def change_filename(filename):
    fileinfo = os.path.splitext(filename)
    filename = datetime.datetime.now().strftime("%Y%m%d%H%M%S") + str(uuid.uuid4().hex) + fileinfo[-1]
    return filename
```
保存上传文件
```
def movie_add():
    form = MovieForm()
    if form.validate_on_submit():
        data = form.data
        file_url = secure_filename(form.url.data.filename)
        file_logo = secure_filename(form.logo.data.filename)
        if not os.path.exists((app.config['UP_DIR'])):
            os.makedirs(app.config['UP_DIR'])
            os.chmod(app.config['UP_DIR'], "rw")
        url = change_filename(file_url)
        logo = change_filename(file_logo)
        form.url.data.save(app.config['UP_DIR'] + url)
        form.logo.data.save(app.config['UP_DIR'] + logo)
```
存入数据库
```
movie = Movie(
    title=data["title"],
    url=url,
    info=data["info"],
    logo=logo,
    star=int(data["star"]),
    playnum=0,
    commentnum=0,
    tag_id=int(data["tag_id"]),
    area=data["area"],
    release_time=data["release_time"],
    length=data["length"],
)
db.session.add(movie)
db.session.commit()
```

# 6-8 电影管理-列表、删除
- 电影列表导航修改链接
```
<a href="{{ url_for('admin.movie_list',page=1) }}">
    <i class="fa fa-circle-o"></i> 电影列表
</a>
```
- 关联查询join(Tag)、filter
```
    page_data = Movie.query.join(Tag).filter(
        Tag.id == Movie.tag_id
    ).order_by(
        Movie.addtime.desc()
    ).paginate(page=page, per_page=10)
```
# 6-9 电影管理-编辑
- 下拉框、选择框需要提前给form赋值
```
if request.method == 'GET':
    form.info.data = movie.info
    form.tag_id.data = movie.tag_id
    form.star.data = movie.star

```
- 编辑电影
```
# 电影编辑
@admin.route("/movie/edit/<int:id>/", methods=['GET', 'POST'])
@admin_login_req
def movie_edit(id=None):
    form = MovieForm()
    form.url.validators = []
    form.logo.validators = []
    movie = Movie.query.get_or_404(int(id))
    if request.method == 'GET':
        form.info.data = movie.info
        form.tag_id.data = movie.tag_id
        form.star.data = movie.star
    if form.validate_on_submit():
        data = form.data
        # 判断片名是否存在
        movie_count = Movie.query.filter_by(title=data['title']).count()
        if movie_count == 1 and movie.title == data['title']:
            flash('片名已经存在', 'err')
            return redirect(url_for('admin.movie_edit', id=int(id)))
        # 判断文件是否存在
        if not os.path.exists((app.config['UP_DIR'])):
            os.makedirs(app.config['UP_DIR'])
            os.chmod(app.config['UP_DIR'], "rw")
        # 判断是否含有属性filename，及判断是否重新上传了视频
        if hasattr(form.url.data, 'filename'):
            file_url = secure_filename(form.url.data.filename)
            movie.url = change_filename(file_url)
            form.url.data.save(app.config['UP_DIR'] + movie.url)

        # 判断是否含有属性filename，及判断是否重新上传了封面
        if hasattr(form.logo.data, 'filename'):
            file_logo = secure_filename(form.logo.data.filename)
            movie.logo = change_filename(file_logo)
            form.logo.data.save(app.config['UP_DIR'] + movie.logo)

        movie.title = data['title']
        movie.info = data['info']
        movie.star = data['star']
        movie.tag_id = data['tag_id']
        movie.area = data['area']
        movie.length = data['length']
        movie.release_time = data['release_time']
        db.session.add(movie)
        db.session.commit()
        flash('修改电影成功', 'ok')
        return redirect(url_for('admin.movie_edit', id=int(id)))
    return render_template('admin/movie_edit.html', form=form, movie=movie)
```
# 6-10 预告管理-添加，列表，删除，编辑
![6-10-1电影管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-10-1.jpg?raw=true)

# 6-11 会员管理-列表，删除，查看
![6-11-1电影管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-11-1.jpg?raw=true)

# 6-12 评论管理-列表，删除
![6-12-1电影管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-12-1.jpg?raw=true)
- 关联查询
```
page_data = Comment.query.join(
        Movie
    ).join(
        User
    ).filter(
        Movie.id == Comment.movie_id,
        User.id == Comment.user_id
    ).order_by(
        Comment.id.desc()
    ).paginate(page=page, per_page=10)
```

# 6-13 收藏管理-列表，删除
![6-13-1电影管理](https://github.com/ze25800000/movie-flask/blob/master/pic/6-13-1.jpg?raw=true)

# 6-14 修改密码
![6-14-1](https://github.com/ze25800000/movie-flask/blob/master/pic/6-14-1.jpg?raw=true)
- forms.py中增加类PwdForm
```
class PwdForm(FlaskForm):
    old_pwd = PasswordField(
        label="旧密码",
        validators=[
            DataRequired("请输入旧密码！")
        ],
        description="旧密码",
        render_kw={
            "class": "form-control",
            "placeholder": "请输入旧密码！",
            "required": False
        }
    )
    new_pwd = PasswordField(
        label="新密码",
        validators=[
            DataRequired("请输入新密码！")
        ],
        description="新密码",
        render_kw={
            "class": "form-control",
            "placeholder": "请输入新密码！",
            "required": False
        }
    )
    submit = SubmitField(
        '编辑',
        render_kw={
            "class": "btn btn-primary"
        }
    )
    # 调用模型中admin的方法check_pwd，验证旧密码是否正确
    def validate_old_pwd(self, field):
        from flask import session
        pwd = field.data
        name = session['admin']
        admin = Admin.query.filter_by(
            name=name
        ).first()
        if not admin.check_pwd(pwd):
            raise ValidationError('旧密码错误')
```
- views.py中
```
# 修改密码页面
@admin.route("/pwd/", methods=['GET', 'POST'])
@admin_login_req
def pwd():
    form = PwdForm()
    if form.validate_on_submit():
        data = form.data
        admin = Admin.query.filter_by(name=session['admin']).first()
        # 引入generate_password_hash，将密码转换
        from werkzeug.security import generate_password_hash
        admin.pwd = generate_password_hash(data['new_pwd'])
        db.session.add(admin)
        db.session.commit()
        flash('修改密码成功，请重新登录！', 'ok')
        # 修改密码成功后让用户重新登录
        return redirect(url_for('admin.logout'))
    return render_template('admin/pwd.html', form=form)
```

# 6-15 日志管理
![6-15-1](https://github.com/ze25800000/movie-flask/blob/master/pic/6-15-1.jpg?raw=true)
- 上下应用处理器
```
# admin/views.py添加
# 上下应用处理器
@admin.context_processor
def tpl_extra():
    data = dict(
        online_time=datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    )
    return data
# 在html中直接使用
{{ online_time }}
```
- 操作日志
```
oplog = Oplog(
    admin_id=session["admin_id"],
    ip=request.remote_addr,
    reason="添加标签%s" % data["name"]
)
db.session.add(oplog)
db.session.commit()
```
- 管理员登陆日志
```
adminlog = Adminlog(
    admin_id=admin.id,
    ip=request.remote_addr
)
db.session.add(adminlog)
db.session.commit()
```

# 7-1 权限管理-添加、列表、删除、编辑
![7-1-1](https://github.com/ze25800000/movie-flask/blob/master/pic/7-1-1.jpg?raw=true)

# 7-2 角色管理-添加、列表、删除、编辑
![7-2-1](https://github.com/ze25800000/movie-flask/blob/master/pic/7-2-1.jpg?raw=true)
- forms.py中使用
```
auth_list = Auth.query.all()
...
...

auths = SelectMultipleField(
    label="权限列表",
    validators=[
        DataRequired('请选择权限')
    ],
    coerce=int,
    choices=[(v.id, v.name) for v in auth_list],
    description="权限列表",
    render_kw={
        "class": "form-control",
        "required": False
    }
)
```
- 列表转字符串
```
role = Role(
    name=data['name'],
    auths=",".join(map(lambda v: str(v), data['auths']))
)
```
- 字符串转列表
```
if request.method == "GET":
    form.auths.data = list(map(lambda v: int(v), role.auths.split(",")))
```

# 7-3 管理员管理-添加、列表
![7-3-1](https://github.com/ze25800000/movie-flask/blob/master/pic/7-3-1.jpg?raw=true)

# 7-4 访问权限控制
- 定义权限装饰器
![7-4-1](https://github.com/ze25800000/movie-flask/blob/master/pic/7-4-1.jpg?raw=true)
```
def admin_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        admin = Admin.query.join(
            Role
        ).filter(
            Role.id == Admin.role_id,
            Admin.id == session['admin_id']
        ).first()
        auths = admin.role.auths
        auths = list(map(lambda v: int(v), auths.split(",")))
        auth_list = Auth.query.all()
        urls = [v.url for v in auth_list for val in auths if val == v.id]
        rule = request.url_rule
        if str(rule) not in urls:
            abort(404)
        return f(*args, **kwargs)

    return decorated_function
```

# 8-1 会员注册
![8-1-1](https://github.com/ze25800000/movie-flask/blob/master/pic/8-1-1.jpg?raw=true)
- app/home/form.py
```
class RegistForm(FlaskForm):
    name = StringField(
        label="昵称",
        validators=[
            DataRequired("请输入昵称！")
        ],
        description="昵称",
        render_kw={
            "class": "form-control input-lg",
            "placeholder": "请输入昵称！",
            "required": False
        }
    )
    email = StringField(
        label="邮箱",
        validators=[
            DataRequired("请输入邮箱！"),
            Email("邮箱格式不正确！")
        ],
        description="邮箱",
        render_kw={
            "class": "form-control input-lg",
            "placeholder": "请输入邮箱！",
            "required": False
        }
    )
    phone = StringField(
        label="手机",
        validators=[
            DataRequired("请输入手机！"),
            Regexp("^1[358]\d{9}$", message="手机格式不正确")
        ],
        description="手机",
        render_kw={
            "class": "form-control input-lg",
            "placeholder": "请输入手机！",
            "required": False
        }
    )
    pwd = PasswordField(
        label="密码",
        validators=[
            DataRequired("请输入密码！")
        ],
        description="密码",
        render_kw={
            "class": "form-control input-lg",
            "placeholder": "请输入密码！",
            "required": False
        }
    )
    repwd = PasswordField(
        label="确认密码",
        validators=[
            DataRequired("请输入确认密码！"),
            EqualTo('pwd', "两次密码不一致")
        ],
        description="确认密码",
        render_kw={
            "class": "form-control input-lg",
            "placeholder": "请输入确认密码！",
            "required": False
        }
    )
    submit = SubmitField(
        '注册',
        render_kw={
            "class": "btn btn-lg btn-success btn-block"
        }
    )
    # 验证昵称是否已经存在
    def validate_name(self, field):
        name = field.data
        user = User.query.filter_by(name=name).count()
        if user == 1:
            raise ValidationError('昵称已存在')

    # 验证邮箱是否已经存在
    def validate_email(self, field):
        email = field.data
        user = User.query.filter_by(email=email).count()
        if user == 1:
            raise ValidationError('邮箱已存在')
     # 验证电话号码是否已经存在
    def validate_phone(self, field):
        phone = field.data
        user = User.query.filter_by(phone=phone).count()
        if user == 1:
            raise ValidationError('手机号已存在')
```

# 8-2 会员登录
![8-2-1](https://github.com/ze25800000/movie-flask/blob/master/pic/8-2-1.jpg?raw=true)
- 登录装饰器
```
def user_login_req(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if "user" not in session:
            return redirect(url_for("home.login", next=request.url))
        return f(*args, **kwargs)

    return decorated_function
```

# 8-3 修改会员资料
![8-3-1](https://github.com/ze25800000/movie-flask/blob/master/pic/8-3-1.jpg?raw=true)

# 8-4 修改密码
![8-4-1](https://github.com/ze25800000/movie-flask/blob/master/pic/8-4-1.jpg?raw=true)

# 8-5 会员登录日志
![8-5-1](https://github.com/ze25800000/movie-flask/blob/master/pic/8-5-1.jpg?raw=true)

# 9-1 上映预告
![9-1-1](https://github.com/ze25800000/movie-flask/blob/master/pic/9-1-1.jpg?raw=true)

# 9-2 标签筛选、电影分页
![9-2-1](https://github.com/ze25800000/movie-flask/blob/master/pic/9-2-1.jpg?raw=true)

# 9-3 电影搜索、搜索分页
![9-3-1](https://github.com/ze25800000/movie-flask/blob/master/pic/9-3-1.jpg?raw=true)
- 使用filter模糊搜索
```
page_data = Movie.query.filter(
        Movie.title.ilike('%' + key + '%')
    ).order_by(
        Movie.addtime.desc()
    ).paginate(page=page, per_page=10)
```

# 9-4 电影详情、电影播放
![9-4-1](https://github.com/ze25800000/movie-flask/blob/master/pic/9-4-1.jpg?raw=true)

# 10-1 电影评论、统计
![10-1-1](https://github.com/ze25800000/movie-flask/blob/master/pic/10-1-1.jpg?raw=true)
- 页面中判断是否已登录
```
{% if "user" not in session %}
<div class="alert alert-danger alert-dismissible" role="alert">
    <button type="button" class="close" data-dismiss="alert">
        <span aria-hidden="true">×</span>
        <span class="sr-only">Close</span>
    </button>
    <strong>请先<a href="{{ url_for('home.login') }}" target="_blank" class="text-info">登录</a>，才可参与评论！</strong>
</div>
{% endif %}
```